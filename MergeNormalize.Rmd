---
title: "Merging and Normalization"
output: html_notebook
---

*Read in data from processed libraries*

Combines the outputs of all processed libraries into a single list. This part requires pre-specified inputs for 

```{r}
array <- list()
array[[1]] <- readRDS("ASt-1_preprocessed.rds")
array[[2]] <- readRDS("ASt-2_preprocessed.rds")
array[[3]] <- readRDS("CPt-1_preprocessed.rds")
array[[4]] <- readRDS("CPt-2_preprocessed.rds")
array[[5]] <- readRDS("CPt-3_preprocessed.rds")
array[[6]] <- readRDS("CeA-1_preprocessed.rds")
array[[7]] <- readRDS("CeA-2_preprocessed.rds")
array[[8]] <- readRDS("CeA-3_preprocessed.rds")

array <- merge(x = array[[1]], y = list(array[[2]], array[[3]], array[[4]], array[[5]], array[[6]], array[[7]], array[[8]]))
```

*Filter genes*

Need to remove genes that are not expressed widely in order to reduce noise prior to HVG selection. 

```{r}
array <- subset(array, features = which(rowSums(array) >= 10))
```

*SCTransform*

SCTransform is the best performing normalization method (Germain et al., 2020). It uses a variance stabilizing transform based on Pearson residuals to eliminate count depth differences and robustly approximate log-normalization. 5000 genes are selected as HVGs to ensure maximum resolution.

```{r}
array <- SCTransform(array, variable.features.n = 5000, verbose = FALSE)
```

*Linear dimensionality reduction with PCA*

Plot is sanity check for batch effects.

```{r}
array <- RunPCA(array, verbose = FALSE)

DimPlot(array)
DimPlot(array, group.by = "region")
```

*Nonlinear dimensionality reduction with UMAP*

Plot is sanity check for dataset complexity and batch effects.

```{r}
array <- RunUMAP(array, dims = 1:50, n.epochs = 1000)

DimPlot(array)
DimPlot(array, group.by = "region")
```

*Save the normalized dataset for downstream analysis*

```{r}
saveRDS(array, file = "ASt_CeA_CPt_mergenormalize.rds")
```